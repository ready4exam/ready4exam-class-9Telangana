<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Select Book & Chapter — Class 9 Telangana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { theme:{ extend:{ fontFamily:{sans:['Inter','sans-serif']}, colors:{'cbse-blue':'#1a3e6a','cbse-light':'#f5f7fa','accent-gold':'#ffb703'} } } }</script>
  <style>.topic-btn{ width:100%;padding:1rem;margin-bottom:.75rem;border-radius:.75rem;background:#fff;border:1px solid #d1d5db;cursor:pointer;text-align:left;box-shadow:0 2px 6px rgba(2,6,23,.05);transition:.2s; } .topic-btn:hover{background:#f5f7fa; transform: translateY(-1px);} .topic-btn.selected{border-color:#1a3e6a;background:#eff6ff;ring:2px solid #1a3e6a} .difficulty-btn{ padding:.6rem 1.25rem;border-radius:.75rem;font-weight:600;cursor:pointer;transition:.2s; opacity: 0.8; } .difficulty-btn:hover{opacity: 1;} .difficulty-btn.selected{opacity: 1; box-shadow:0 6px 18px rgba(26,62,106,.2); transform: scale(1.05);}</style>
  <script>window.__firebase_config = { apiKey: "AIzaSyAXdKiYRxBKAj280YcNuNwlKKDp85xpOWQ", authDomain: "quiz-signon.firebaseapp.com", projectId: "quiz-signon", storageBucket: "quiz-signon.appspot.com", messagingSenderId: "863414222321", appId: "1:863414222321:web:819f5564825308bcd9d850", measurementId: "G-4EFDM0CRYY", supabaseUrl: "https://zqhzekzilalbszpfwxhn.supabase.co", supabaseAnonKey: "sb_publishable_YkwxnAk1xdI8n2GOhTn4VA_v7viBnys" };</script>
</head>
<body class="bg-cbse-light min-h-screen flex flex-col">
<header class="bg-cbse-blue py-4 shadow-lg"><div class="max-w-6xl mx-auto flex justify-between items-center px-6"><h1 class="text-2xl font-extrabold text-accent-gold">Ready4<span class="text-white">Exam</span></h1><button onclick="location.href='index.html'" class="text-white underline">← Back</button></div></header>
<main class="flex-grow max-w-3xl mx-auto px-4 py-8 w-full">
  <h2 id="page-title" class="text-3xl font-extrabold text-cbse-blue mb-2 text-center">Select Book</h2>
  <p id="subject-desc" class="text-center text-gray-600 mb-8 font-medium"></p>
  <div id="content-container" class="space-y-2 mb-8"></div>
  <div id="difficulty-container" class="hidden mb-10 p-6 bg-white rounded-xl shadow-sm border border-gray-100 text-center"><h3 class="text-xl font-bold text-cbse-blue mb-4">Choose Difficulty Level</h3><div class="flex flex-wrap justify-center gap-4"><button data-diff="Simple" class="difficulty-btn bg-green-600 text-white">Simple</button><button data-diff="Medium" class="difficulty-btn bg-yellow-500 text-white">Medium</button><button data-diff="Advanced" class="difficulty-btn bg-red-600 text-white">Advanced</button></div></div>
  <p id="error-msg" class="hidden text-center text-red-500 mb-4 font-semibold"></p>
  <div class="text-center sticky bottom-6 md:static"><button id="start-quiz" disabled class="w-full md:w-auto px-12 py-4 bg-cbse-blue text-white rounded-xl font-bold text-lg hover:bg-blue-800 transition shadow-lg disabled:opacity-40 disabled:cursor-not-allowed">Start Quiz</button></div>
</main>
<footer class="bg-cbse-blue py-6 text-center text-white mt-12"><small>© 2025 Ready4Exam Academic Portal</small></footer>
<script type="module">
import curriculum from "./js/curriculum.js";
import { transliterate as tr } from "https://cdn.jsdelivr.net/npm/transliteration/+esm";
import { requireAuth } from "./js/auth-paywall.js";
import { checkClassAccess, showExpiredPopup } from "./js/firebase-expiry.js";

// --- CONFIGURATION ---
const DB_CLASS_ID = "9telangana"; // Matches your database table suffix
const TRACKING_ID = "TS_9";       // Matches your Admin Dashboard Badge logic

const subject  = new URLSearchParams(location.search).get("subject") || "";
const content = document.getElementById("content-container"), diffBox = document.getElementById("difficulty-container"), startBtn = document.getElementById("start-quiz"), errorMsg = document.getElementById("error-msg"), subjectDesc = document.getElementById("subject-desc");
let selectedBook = null, selectedChapter = null, selectedDifficulty = null;
const meta = { Physics: "Explore mechanics, waves & thermodynamics.", Chemistry: "Atoms, reactions, bonding & periodicity.", Biology: "Cells, plants, human body & ecosystems.", Mathematics: "Numbers, algebra, geometry & graphs.", Hindi: "हिंदी साहित्य और व्याकरण का अभ्यास करें。" };
subjectDesc.textContent = meta[subject] || "";

function renderBooks(){
  const data = curriculum[subject];
  document.getElementById("page-title").textContent = `Select Book`;
  if (!data) { content.innerHTML = "<p class='text-center text-gray-500'>No data available.</p>"; return; }
  const fragment = document.createDocumentFragment();
  Object.keys(data).forEach(book => {
    const btn = document.createElement("button"); btn.className = "topic-btn font-semibold text-lg"; btn.textContent = book; btn.onclick = () => renderChapters(book); fragment.appendChild(btn);
  });
  content.innerHTML = ""; content.appendChild(fragment); diffBox.classList.add("hidden"); startBtn.disabled = true;
}

function renderChapters(book){
  selectedBook = book;
  const chapters = curriculum[subject][book];
  document.getElementById("page-title").textContent = book;
  const fragment = document.createDocumentFragment();
  chapters.forEach(ch => {
    const title = ch.chapter_title || ch.title || ch;
    const btn = document.createElement("button"); btn.className = "topic-btn"; btn.textContent = title; btn.onclick = (e) => selectChapter(title, e.currentTarget); fragment.appendChild(btn);
  });
  const back = document.createElement("button"); back.className = "w-full text-cbse-blue font-bold py-2 mt-2 hover:underline"; back.textContent = "← Change Book"; back.onclick = renderBooks; fragment.appendChild(back);
  content.innerHTML = ""; content.appendChild(fragment); window.scrollTo({ top: 0, behavior: 'smooth' });
}

function selectChapter(title, button){
  document.querySelectorAll(".topic-btn").forEach(b => b.classList.remove("selected")); button.classList.add("selected"); selectedChapter = title; diffBox.classList.remove("hidden");
  setTimeout(() => { diffBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100);
}

document.querySelectorAll(".difficulty-btn").forEach(btn => {
  btn.onclick = e => {
    document.querySelectorAll(".difficulty-btn").forEach(x => x.classList.remove("selected")); e.target.classList.add("selected"); selectedDifficulty = e.target.dataset.diff; startBtn.disabled = false; errorMsg.classList.add("hidden");
  };
});

function buildTableName(chapter){
  let chapterSlug = tr(chapter || "").toLowerCase().replace(/[^a-z0-9\s]/g, " ").replace(/\s+/g, " ").trim();
  const skip = ["as","of","the","a","an","in","on","for","to","ki","ke","ka"];
  const words = chapterSlug.split(" ").filter(w => !skip.includes(w));
  const first = words[0] || "ch"; const last  = words[words.length - 1] || "x";
  let subjectSlug = tr(subject).toLowerCase().replace(/[^a-z0-9\s]/g, "").split(" ")[0] || "sub";
  return `${subjectSlug}_${first}_${last}_${DB_CLASS_ID}_quiz`;
}

startBtn.onclick = async () => {
  if (!selectedChapter || !selectedDifficulty) { errorMsg.textContent = "Select chapter & difficulty."; errorMsg.classList.remove("hidden"); return; }
  try {
    const user = await requireAuth(); 
    startBtn.disabled = true; startBtn.textContent = "Registering Access...";
    
    // Pass TS_9 here to trigger the bypass logic
    const access = await checkClassAccess(TRACKING_ID, subject); 
    
    if (access.allowed) {
      const table = buildTableName(selectedChapter);
      const params = new URLSearchParams({ class: TRACKING_ID, subject, book: selectedBook, chapter: selectedChapter, difficulty: selectedDifficulty, table, chapter_name: selectedChapter });
      location.href = `quiz-engine.html?${params.toString()}`;
    } else { showExpiredPopup(access.reason); startBtn.disabled = false; startBtn.textContent = "Start Quiz"; }
  } catch (err) { console.error("Auth failed:", err); startBtn.disabled = false; startBtn.textContent = "Start Quiz"; }
};
renderBooks();
</script>
</body>
</html>
